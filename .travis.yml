language: python
python:
  - "3.6"

sudo: required
dist: trusty

branches:
  only:
    - master
    - dev

install:
  - pip install -r requirements.txt
  # Install TeXLive
  # steps copied from https://gist.githubusercontent.com/seisman/ad00252a9f03fc644146a11e6983d9c5/raw/install-tl.sh ::
  - REMOTE="http://ctan.sharelatex.com/tex-archive/systems/texlive/tlnet"

  - mkdir -p /tmp/install-texlive
  - cd /tmp/install-texlive/

  - curl -sSL $REMOTE/install-tl-unx.tar.gz | tar -xz -C ./ --strip-components=1

  - |
    cat << EOF > texlive.profile
    selected_scheme scheme-basic
    TEXMFHOME ~/.texmf
    collection-basic 1
    collection-fontsrecommended 1
    collection-langchinese 1
    collection-latex 1
    collection-latexrecommended 1
    collection-xetex 1
    option_doc 0
    option_src 0
    EOF

  - PLATFORM=$(./install-tl --print-platform)
  - TEXLIVE=$(./install-tl --version | egrep -o "20..")
  - TEXBIN="/usr/local/texlive/${TEXLIVE}/bin/${PLATFORM}"
  - ./install-tl -q -profile texlive.profile -repository $REMOTE

  - echo PATH=$PATH:$TEXBIN
  - echo 'export PATH=$PATH':$TEXBIN >> ~/.bash_profile
  - $TEXBIN/tlmgr install tabulary latexmk ulem environ trimspaces titlesec \
                  varwidth framed threeparttable wrapfig upquote capt-of \
                  multirow eqparbox needspace fncychap
  

  - source ~/.bash_profile
  - export TLMGR=`which tlmgr`
  # update texlive
  - sudo $TLMGR update --self --all -repository http://ctan.sharelatex.com/tex-archive/systems/texlive/tlnet/

script:
  - make html
  - make latexpdf

after_success:
  - cp build/latex/Makefile.pdf build/html/

deploy:
  provider: pages
  skip_cleanup: true
  github_token: ${GH_TOKEN}
  local_dir: build/html
  on:
    branch: master
